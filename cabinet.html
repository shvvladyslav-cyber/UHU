<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UHU Kassel — Кабинет (CRM)</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0a0f22" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --bg:#0a0f22;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12);
      --txt:#e9eef7;
      --muted:rgba(233,238,247,.75);
      --brand:#2b76ff;
      --warn:#ffd400;
      --ok:#21c55d;
      --bad:#ff4d4f;
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 520px at 20% 10%, rgba(43,118,255,.25), transparent 55%),
                  radial-gradient(900px 520px at 80% 5%, rgba(255,212,0,.18), transparent 55%),
                  linear-gradient(180deg, #060916, #0a0f22);
      color:var(--txt);
      min-height:100vh;
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1080px; margin:0 auto; padding:16px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      position:sticky; top:10px; z-index:10;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .brand img{width:42px; height:42px; border-radius:14px; border:1px solid var(--line); background:#fff}
    .brand b{display:block; letter-spacing:.2px}
    .brand small{display:block; color:var(--muted); font-weight:800}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:14px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{
      padding:14px;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:var(--card);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    h1{margin:0; font-size:18px}
    h2{margin:0 0 10px; font-size:16px}
    p{margin:8px 0; color:var(--muted); line-height:1.5}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:10px 14px; border-radius:14px; font-weight:950;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      transition:transform .06s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(135deg, rgba(43,118,255,.35), rgba(255,212,0,.18)); border-color:rgba(43,118,255,.35)}
    .btn.ok{background:rgba(33,197,93,.14); border-color:rgba(33,197,93,.35)}
    .btn.bad{background:rgba(255,77,79,.12); border-color:rgba(255,77,79,.35)}
    .inp{
      width:100%; padding:10px 12px; border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25); color:var(--txt); outline:none;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      font-weight:900;
      color:var(--muted);
    }
    .dot{width:8px; height:8px; border-radius:99px; display:inline-block; background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .sep{height:1px; background:var(--line); margin:12px 0}
    .hint{font-size:12px}
    .hide{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img src="/logo.png" alt="UHU" />
        <div>
          <b>UHU Kassel — Кабинет</b>
          <small>быстрые ссылки + проверка CRM</small>
        </div>
      </div>
      <div class="row">
        <a class="btn" href="/" rel="noopener">← На сайт</a>
        <a class="btn" href="/impressum.html" rel="noopener">Impressum</a>
        <a class="btn" href="/datenschutz.html" rel="noopener">Datenschutz</a>
      </div>
    </div>

    <div id="gate" class="card" style="margin-top:14px">
      <div class="pill"><span class="dot bad"></span>Доступ ограничен</div>
      <p>Эта страница открывается только по ссылке с параметром <b>?admin=1</b>.</p>
      <p class="hint">Открой главную так: <span class="mono">https://uhu.digital/?admin=1</span> → нажми кнопку <b>Кабинет</b>.</p>
    </div>

    <div id="main" class="grid hide">
      <div class="card">
        <h1>1) Главные кнопки</h1>
        <p class="hint">Кнопки берут ссылки из <span class="mono">crm-config.js</span>. Можно сохранить свою ссылку в этом кабинете — она запомнится в браузере.</p>

        <div class="row" style="margin-top:10px">
          <a id="openSheet" class="btn primary" href="#" target="_blank" rel="noopener">Открыть CRM (Google Sheet)</a>
          <a id="openEndpoint" class="btn" href="#" target="_blank" rel="noopener">Проверить Web App (doGet)</a>
          <a id="openTelegram" class="btn" href="#" target="_blank" rel="noopener">Telegram</a>
        </div>

        <div class="sep"></div>

        <h2>2) Ссылки (для тебя)</h2>
        <label class="hint">Ссылка на Google Sheet (CRM)</label>
        <input id="sheetUrl" class="inp mono" placeholder="https://docs.google.com/spreadsheets/d/....../edit" />

        <div style="height:8px"></div>

        <label class="hint">URL Web App из Apps Script</label>
        <input id="endpointUrl" class="inp mono" placeholder="https://script.google.com/macros/s/....../exec" />

        <div class="row" style="margin-top:10px">
          <button id="save" class="btn ok" type="button">Сохранить в этом браузере</button>
          <button id="reset" class="btn bad" type="button">Сбросить</button>
        </div>

        <div class="sep"></div>

        <h2>3) Быстрая диагностика</h2>
        <div id="statusBox" class="pill"><span class="dot"></span><span id="statusText">Жду проверки…</span></div>
        <p class="hint">Если заявки не попадают в таблицу: чаще всего не вставлен правильный <b>endpoint</b> (или Web App развёрнут не как "Anyone").</p>
        <div class="row" style="margin-top:10px">
          <button id="testPing" class="btn" type="button">Проверить endpoint</button>
        </div>
        <p id="pingResult" class="mono hint"></p>
      </div>

      <div class="card">
        <h1>Шпаргалка: правильный crm-config.js</h1>
        <p class="hint">Открой файл <span class="mono">crm-config.js</span> в репозитории и вставь свои ссылки.</p>
        <div class="sep"></div>
        <div class="mono" style="white-space:pre-wrap" id="cfgTpl"></div>

        <div class="sep"></div>
        <h2>Готовая таблица (шаблон)</h2>
        <p class="hint">Тебе не нужно вручную настраивать статусы/цвета: Apps Script делает это сам. Но заголовки должны быть в первой строке.</p>
        <div class="mono" style="white-space:pre-wrap; background:rgba(0,0,0,.22); padding:10px; border-radius:14px; border:1px solid var(--line)">
created_at,status,name,phone,service,address,comment,source,page,client_ts,userAgent
        </div>
        <p class="hint">Если хочешь — просто создай лист <b>Leads</b> и оставь его пустым: при первой заявке заголовок добавится автоматически.</p>
      </div>
    </div>
  </div>

  <script src="/crm-config.js"></script>
  <script>
  (function(){
    const p = new URLSearchParams(location.search);
    const isAdmin = p.get('admin') === '1';

    const gate = document.getElementById('gate');
    const main = document.getElementById('main');

    if(isAdmin){
      gate.classList.add('hide');
      main.classList.remove('hide');
    }

    const cfg = (window.UHU_CRM||{});
    const LS_SHEET = 'uhu_sheet_url';
    const LS_ENDPOINT = 'uhu_endpoint_url';

    const sheetInput = document.getElementById('sheetUrl');
    const endpointInput = document.getElementById('endpointUrl');

    function getSheetUrl(){
      return (localStorage.getItem(LS_SHEET) || cfg.sheetUrl || '').trim();
    }
    function getEndpointUrl(){
      return (localStorage.getItem(LS_ENDPOINT) || cfg.endpoint || '').trim();
    }

    function applyLinks(){
      const sheet = getSheetUrl();
      const endpoint = getEndpointUrl();

      if(sheetInput) sheetInput.value = sheet;
      if(endpointInput) endpointInput.value = endpoint;

      const openSheet = document.getElementById('openSheet');
      openSheet.href = sheet || '#';
      openSheet.classList.toggle('bad', !sheet);
      openSheet.classList.toggle('primary', !!sheet);
      openSheet.textContent = sheet ? 'Открыть CRM (Google Sheet)' : 'Вставь sheetUrl → и будет кнопка CRM';

      const openEndpoint = document.getElementById('openEndpoint');
      openEndpoint.href = endpoint ? endpoint : '#';
      openEndpoint.classList.toggle('bad', !endpoint);

      const tg = document.getElementById('openTelegram');
      tg.href = (cfg.telegram || 'https://t.me/UHU_help');

      const tpl = `window.UHU_CRM = {
  enabled: true,
  endpoint: "${endpoint || 'PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE'}",
  sheetUrl: "${sheet || 'PASTE_YOUR_GOOGLE_SHEET_URL_HERE'}",
  telegram: "${cfg.telegram || 'https://t.me/UHU_help'}",
  revolut: "${cfg.revolut || 'https://revolut.me/vladshvachko'}",
  site: "${cfg.site || 'UHU.digital'}",
  currency: "${cfg.currency || 'EUR'}"
};`;
      document.getElementById('cfgTpl').textContent = tpl;
    }

    async function ping(){
      const endpoint = getEndpointUrl();
      const box = document.getElementById('statusBox');
      const dot = box.querySelector('.dot');
      const txt = document.getElementById('statusText');
      const out = document.getElementById('pingResult');

      out.textContent = '';
      dot.classList.remove('ok','bad');
      txt.textContent = 'Проверяю…';

      if(!endpoint || endpoint.includes('PASTE_YOUR')){
        dot.classList.add('bad');
        txt.textContent = 'endpoint не вставлен';
        out.textContent = 'Открой crm-config.js и вставь URL Web App из Apps Script.';
        return;
      }

      try{
        const res = await fetch(endpoint, { method:'GET', cache:'no-store' });
        const t = await res.text();
        if(res.ok && t){
          dot.classList.add('ok');
          txt.textContent = 'endpoint отвечает (OK)';
          out.textContent = t.slice(0, 600);
        }else{
          dot.classList.add('bad');
          txt.textContent = 'endpoint не отвечает корректно';
          out.textContent = 'HTTP '+res.status+': '+t.slice(0, 600);
        }
      }catch(e){
        dot.classList.add('bad');
        txt.textContent = 'ошибка запроса (CORS/сеть/URL)';
        out.textContent = String(e);
      }
    }

    document.getElementById('save')?.addEventListener('click', function(){
      localStorage.setItem(LS_SHEET, (sheetInput.value||'').trim());
      localStorage.setItem(LS_ENDPOINT, (endpointInput.value||'').trim());
      applyLinks();
    });

    document.getElementById('reset')?.addEventListener('click', function(){
      localStorage.removeItem(LS_SHEET);
      localStorage.removeItem(LS_ENDPOINT);
      applyLinks();
    });

    document.getElementById('testPing')?.addEventListener('click', ping);

    applyLinks();
  })();
  </script>
</body>
</html>
